<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Echo</title>
        <!--<link rel="stylesheet" href="{{url_for('static', filename='css/rostopic-web.min.css')}}" />-->
        <link rel="stylesheet" href="{{url_for('static', filename='css/jquery.mobile.icons.min.css')}}" />
        <link rel="stylesheet" href="{{url_for('static', filename='css/jquery.mobile-1.4.5.css')}}" />
        <link rel="stylesheet" href="{{url_for('static', filename='css/jstree.style.css')}}" />
        <script src="{{url_for('static', filename='js/jquery-2.1.4.min.js')}}"></script>
        <script src="{{url_for('static', filename='js/jquery.mobile-1.4.5.min.js')}}"></script>
        <script src="{{url_for('static', filename='js/jstree.js')}}"></script>
        <script>
            window.onload = function() {
                var topic_name = '{{ topic }}';
                $.getJSON('/get_msg_type', 
                    { topic: topic_name }, 
                    function(data) {
                        $('#topic_msg_type').html('Topic: ' + data.msg_struct);
                        
                        var strjson = "{\"core\" : {\"data\" : ["+scan(data.msg_struct)+"]}}";
                        var objjson = $.parseJSON(strjson);
                        //window.console.log(JSON.stringify(objjson, null, 2));
                        $('#data').jstree(objjson);
                    });
              
	            /* bind is for enabling tree expand on tap, for mobile devices */
	            $('#data').bind("select_node.jstree", function (e, data) {
                    return data.instance.toggle_node(data.node);
                });
                
            };
            var curr_id = 0;   
            function scan(obj) {
                var k;
                var ret = "";
                if (obj instanceof Object) {
                    
                    for (k in obj){
                        if (obj.hasOwnProperty(k)){
                            //recursive call to scan property
                            if(obj[k] instanceof Object) {
                                ret += "{\"id\" : " + (++curr_id) + "," +
                                        "\"text\" : \"" + k + "\", " +
                                        "\"children\": [" + scan(obj[k]) + "]},"; 
                            }
                            else {
                                ret += "{\"id\" : " + (++curr_id) + "," +
                                        "\"text\" : \"" + k + " : " + obj[k] + "\"},"; 
                            }
                            /*
                            ret += ("\"" + k + "\"" + ":" + (obj[k] instanceof Object ? 
                                                "\n{[" + scan(obj[k]) + "]},\n " :
                                                "\"" + obj[k] + "\",\n"));
                            */
                        }                
                    }
                    ret = ret.substr(0, ret.length ) ;
                } else {
                    //not an Object so obj[k] here is a value
                };
                return ret.substr(0, ret.length - 1);
            };
        </script>
    </head>
    <body>
        <div id="topic_msg_type"></div>
        <div id="data"></div>
    </body>

</html>
